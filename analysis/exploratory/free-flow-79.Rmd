---
title: "WMATA Queue Jump Effectiveness: Free Flow Speed Checks"
output: 
  html_notebook:
    toc: true
    toc_depth: 2
    toc_float: yes
    df_print: paged
    number_sections: false
    theme: simplex
---

```{r include=FALSE}
source("00-master-exploratory.R", local = TRUE)
path_gtfs <-  file.path(datadir,
                     "wmata-2019-05-18 dl20200205gtfs.zip")
source("02-gtfsprep-exploratory.R", local = TRUE)
```

# Read-in

We'll use a partial sample of Route 79 data for the month of October 2019 to examine free flow speeds through a particular corridor.
```{r message=FALSE, include=FALSE}
# Rawnav from parser; partial export of 79 data
rawnav79_raw <-
  read_csv(
    file = file.path(
      sharepointpath,
      "Client Shared Folder",
      "data",
      "01-interim",
      "FinDat79.csv"
    ),
    col_types =
      cols(
        .default = col_double(),
        Heading = col_character(),
        DoorState = col_character(),
        VehState = col_character(),
        StopWindow = col_character(),
        route_pattern = col_character(),
        route = col_character(),
        pattern = col_character(),
        filename = col_character()
      ))

rawnav_inventory_filtered_79_raw <-
  read_csv(
    file = file.path(
      sharepointpath,
      "Client Shared Folder",
      "data",
      "01-interim",
      "rawnav_inventory_filtered_79.csv"
    ),
    col_types = 
      cols(
        X1 = col_double(),
        fullpath = col_character(),
        filename = col_character(),
        file_busid = col_double(),
        file_id = col_character(),
        taglist = col_character(),
        line_num = col_double(),
        route_pattern = col_character(),
        tag_busid = col_double(),
        tag_date = col_datetime(format = ""),
        tag_time = col_time(format = ""),
        Unk1 = col_double(),
        CanBeMiFt = col_character(),
        route = col_character(),
        pattern = col_character(),
        tag_datetime = col_datetime(format = ""),
        tag_starthour = col_double(),
        wday = col_character()
      ))

rawnav_inventory_filtered_79 <-
  rawnav_inventory_filtered_79_raw %>%
  select(filename,route_pattern, line_num,tag_busid,tag_date,tag_time,tag_datetime,tag_starthour,wday)%>%
  filter(route_pattern == "7901") %>%
  mutate(wday = factor(wday,
                       levels = c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"),
                       ordered = TRUE))

# Intersections
# From: https://opendata.dc.gov/datasets/intersection-points/data
intersections_raw <- 
  read_sf(dsn = file.path(
      sharepointpath,
      "Client Shared Folder",
      "data",
      "00-raw",
      "Intersection_Points-shp",
      "e3661aa5-95cd-4dfb-b189-f9a3bf607bc82020413-1-7zs0bm.h1bpb.shp"
    )) %>%
  st_transform(DCCRS)

intersections <-
  intersections_raw %>%
  mutate(study = OBJECTID %in% c(3234, # "COLUMBIA ROAD NW AND GEORGIA AVENUE NW",
                                 13324, # "PINEY BRANCH ROAD NW AND GEORGIA AVENUE NW"
                                 10991)) %>%#"GEORGIA AVENUE NW AND IRVING STREET NW"
  clean_names()                                 

# 79 -1 is southbound, direction of our QJs

# Route shapes itesm
# get 79 SB shapes -- there are a few but they're basically identical, 
# so we'll just grab the first one. 

wmata_shapes <- 
  read_sf(dsn = file.path(
      sharepointpath,
      "Client Shared Folder",
      "data",
      "00-raw",
      "Metro_Bus_Lines-shp",
      "5606f7ae-68fa-42f5-95c9-9397892d1d552020412-1-19boies.o2k1.shp"
    ))%>%
  st_transform(DCCRS)


shape_7901 <-
  wmata_shapes %>%
  filter(RT_D == "79_S") %>%
  clean_names() 

stops_7901 <-
  get_route_stops(
    gtfs_obj,
    stops,
    "79",
    1
  )

```

This data contains `r scales::comma(nrow(rawnav79_raw))` rows. A sample is shown below. Note that other metadata about these runs is not included in the table below.

```{r}
head(rawnav79_raw)
```

```{r}
files_pulled <-
  rawnav79_raw %>%
  lazy_dt() %>%
  distinct(filename) %>%
  collect() 
```

Only about `r nrow(files_pulled)` distinct rawnav zip files are included in this dataset. Each rawnav zip file included will contain some 79 NB, 79SB, pull-in, pull-out, and records for some other routes that are on the same block as a 79 trip.

```{r}
runs_pulled <-
  rawnav79_raw %>%
  lazy_dt() %>%
  filter(route_pattern == "7901") %>%
  distinct(filename,IndexTripStartInCleanData) %>%
  collect()

```
Around `r nrow(runs_pulled)` unique runs of the 79 southbound are included in this datset.

Because of some challenges with the data extract for these records, we don't have the specific associations of time periods for individual trips here. However, we can say what time periods and dates were present in the files that were read in from a separate metadata table. Once properly filtered, this tables' distribution of run dates and times will differ only slightly from the data extract used in the analysis below.

```{r}
rawnav_inventory_filtered_79_ourdata <-
  rawnav_inventory_filtered_79 %>%
  semi_join(runs_pulled, by = "filename")

```

It looks like we pulled `r nrow(runs_pulled)` 79 Southbound runs out of `r nrow(rawnav_inventory_filtered_79)` runs that are in the October 2019 data: about `r scales::percent(nrow(runs_pulled) / nrow(rawnav_inventory_filtered_79))`.

The distribution of trips by time of day and day of week are shown below. Start hour is shown on the x axis, day of week on the y-axis, and the number of bus runs in the dataset in each cell.

```{r message=FALSE, warning=FALSE}
df <- 
rawnav_inventory_filtered_79_ourdata %>%
 count(tag_starthour, wday)

make_heat <- function(dfin, val, text){
  ggplot(dfin, aes(wday, tag_starthour)) + 
    geom_tile(aes(fill = {{val}})) +
    scale_fill_continuous(type = "viridis") +
    geom_text(aes(label = {{text}}),
              color = "grey80") +
    scale_y_reverse()
}

make_heat(df,n,n)

```


By comparison, the distribution of all 79 southbound runs by day of week and hour for October 2019 is shown below.
```{r message=FALSE, warning=FALSE}
df2 <- 
rawnav_inventory_filtered_79 %>%
 count(tag_starthour, wday)

make_heat(df2,n,n)

```

The percentage of trips captured in each day and hour are shown below.

```{r}
df3 <- 
  df2 %>%
  left_join(df, 
            by = c("tag_starthour", "wday"),
            suffix = c(".total",".sample")) %>%
  mutate(percent = n.sample / n.total,
         percent_fmt = scales::percent(percent, accuracy = 1)) %>%
  drop_na(percent)

make_heat(df3,percent,percent_fmt)
```

# Defining boundaries for our segment analyses

First, where are our DC intersections around the 79 southbound?

```{r}
shape_7901_buff <- st_buffer(shape_7901, dist = units::set_units(100,"ft"))

intersections_7901 <-
  intersections %>%
  filter(st_intersects(., 
                       shape_7901_buff, 
                       sparse = FALSE)) %>%
  arrange(study)
```

Let's look at [hte piney branch intersection](https://www.google.com/maps/place/Piney+Branch+Rd+NW+%26+Georgia+Ave+NW,+Washington,+DC+20011,+USA/@38.9651607,-77.0298217,15.44z/data=!4m5!3m4!1s0x89b7c889f9d2cced:0x2f64ed3efceac785!8m2!3d38.9674749!4d-77.0274863), as it doesn't have two queue jumps adjacent to each other. From Piney Branch in Yellow, it's about 395 feet to the previous intersection at Underwood, but the previous signalized intersection is much further back at Van Buren Street. All of the intersections shown between Piney Branch and next stop are signalized with the exception of the one immediately south of Piney Branch at Tuckerman St. 

Note that map layers can be toggled on and off in left panel
```{r message=FALSE, warning=FALSE, out.width=}
{mapview(intersections_7901, 
        zcol = "study") + 
    mapview(stops_7901, col.regions = "red", layer.name = "79 SB stops") +
  mapview(shape_7901_buff, legend = FALSE) +
  mapview(shape_7901, legend = TRUE, layer.name = "79 SB")}@map %>%
  leaflet::addMeasure() %>%
  leaflet::setView(lat = 38.96433, lng = -77.02779, zoom = 16)
```

We'll just create a linestring based on coordinates picked off the map, roughly 300 ft before the QJ (just south of Underwood) and 1,500 feet after (half way between third and fourth intersection out). 
```{r}
segment_piney <- 
  tribble(~source,~lat, ~lon,
         "start", 38.968452,-77.027389,
         "end" ,38.963196,-77.027872) %>%
  st_as_sf(., 
           coords = c("lon", "lat"),
           crs = 4326L, #WGS84
           agr = "constant") %>%
  summarize() %>%
  st_cast("LINESTRING") %>%
  st_transform(DCCRS)

segment_piney_buff <-
  segment_piney %>%
  st_buffer(., dist = 50, endCapStyle = "FLAT")
```

Any case where points are continuously within this short buffer will be used for analysis.
```{r, out.width = '100%'}
{mapview(intersections_7901, 
        zcol = "study") + 
    mapview(stops_7901, col.regions = "red", layer.name = "79 SB stops") +
  mapview(segment_piney_buff, legend = TRUE, layer.name = "Piney Segment")}@map %>%
  addMeasure() %>%
  leaflet::setView(lat = 38.96433, lng = -77.02779, zoom = 16)
```


# Filter RawNav to data in these points

To save processing time, we'll filter to 79 southboundcases between several stops, then convert points to geometry, then filter to those in our study area. 

First, let's look once more at where the stop codes are since we don't have GTFS data joined in
```{r}
rawnav7901_preview <-
  rawnav79_raw %>%
  lazy_dt() %>%
  filter(route_pattern == "7901") %>%
  filter(filename == first(filename)) %>%
  filter(IndexTripStartInCleanData == first(IndexTripStartInCleanData)) %>%
  collect() %>%
  st_as_sf(., 
           coords = c("Long", "Lat"),
           crs = 4326L, #WGS84
           agr = "constant") %>%
  st_transform(DCCRS)
```

Looks like we need points between stops E03 and E05.
```{r message=FALSE, warning=FALSE, out.width=}
#so sorry about this formatting :)
{
  mapview(segment_piney_buff) +
  mapview(filter(rawnav7901_preview,str_detect(StopWindow,"E")), 
          zcol = "StopWindow",
          legend = FALSE) 
}@map %>%
  leaflet::setView(lat = 38.96433, lng = -77.02779, zoom = 16)
```

We'll create a stop segment field based on the stop a route has just *departed*, filter to points in our stop segments, convert to geometry, intersect against our buffer.

```{r}
rawnav79 <-
  rawnav79_raw %>%
  lazy_dt() %>%
  filter(route_pattern == "7901") %>% 
  # note, i'm notsure this is a perfect way to group, seeing some potential
  #issues
  group_by(filename,IndexTripStartInCleanData) %>%
  mutate(hit_stop = str_extract(StopWindow,"E\\d*"),
         stop_segment = hit_stop) %>%
  collect() %>%
  fill(stop_segment, .direction = "down")


rawnav79_piney_1 <-
  rawnav79 %>%
  lazy_dt() %>%
  #technically further than we need to go with E05, but being safe
  filter(stop_segment %in% c("E03","E04","E05")) %>%
  ungroup() %>%
  collect() %>%
  st_as_sf(., 
           coords = c("Long", "Lat"),
           crs = 4326L, #WGS84
           agr = "constant") %>%
  st_transform(DCCRS)

rawnav79_piney <-
  rawnav79_piney_1 %>%
  filter(st_intersects(., 
                       segment_piney_buff, 
                       sparse = FALSE))

```

Down from 10 million observations to just 100k! 

Let's take a look at one trip

```{r, out.width = '100%'}
mapview(segment_piney_buff) +
  {  rawnav79_piney %>%
      filter(IndexTripStartInCleanData == first(IndexTripStartInCleanData )) %>%
      filter(filename == first(filename)) %>%
      mapview(., zcol = "stop_segment")}

```

To keep it simple, let's collapse now to the first and last point, calculate the odometer distance and time differences, and get some speeds.

```{r}
rawnav79_piney_run_sum_1 <-
  rawnav79_piney %>%
  st_drop_geometry() %>%
  group_by(filename,IndexTripStartInCleanData) %>%
  summarize(odo_seg_start = min(OdomtFt, na.rm = TRUE),
            odo_seg_end = max(OdomtFt, na.rm = TRUE),
            time_seg_start = min(SecPastSt, na.rm = TRUE),
            time_seg_end = max(SecPastSt, na.rm = TRUE),
            odo_seg_diff = odo_seg_end - odo_seg_start,
            time_seg_diff = time_seg_end - time_seg_start,
            ft_per_sec = odo_seg_diff / time_seg_diff,
            mph = as.numeric(ft_per_sec) / 1.467) #approximation because i'm a hack

```

We'll remove bus runs with potential data quality issues before calculating distributions. In particular, our segment is `r st_length(segment_piney)`; we'll filter out any cases where the distance traveled was significantly longer or shorter than this.
```{r}
rawnav79_piney_run_sum_2 <-
  rawnav79_piney_run_sum_1 %>%
  filter(odo_seg_diff >(1919-200) & odo_seg_diff < (1919+200))
```

The distribution of trip speeds is shown below.

```{r}
ggplot(rawnav79_piney_run_sum_2) +
  geom_histogram(aes(x = mph)) +
  FITP_Theme
```

Notably, our universe of trips used for this sample analysis skews towards the PM Peak. While speeds are likely to be lower during this time of day, this is also the off-direction for peak hour travel. As a result, we can expect some speeds in the full sample to be both higher and lower than these. Moreover, there's also a school slow zone somewhat south of this intersection, and perhaps buses are slowing down later on, especially during school hours that might overlap with many of the trips in this dataset: [See google maps link here.](https://www.google.com/maps/@38.9647409,-77.0277021,3a,41.1y,217.38h,85.85t/data=!3m6!1e1!3m4!1sPbn3DM4vSlkDSPt9ZM-mqA!2e0!7i16384!8i8192)

Using this dataset as a distribution, the range of free flow travel speeds is between 15 and 18 mph. By comparison, the posted speed in this segment Southbound is 30 mph prior to the Piney Branch intersection. This said, even the highest speed trip in this sample barely exceeds 20 mph.

```{r}
rawnav79_piney_run_sum_2$mph %>%
  quantile(probs = c(.02,.05,.1,.25,.5,.75,.9,.95,.98))
```

